# ğŸ“‹ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ (v2)

## ğŸ¯ ì—…ë°ì´íŠ¸ ë‚´ìš©

### 1. ë‹¹ì„  ê¸°ì¤€ ì‹œìŠ¤í…œ
- **elections.winning_criteria**: íˆ¬í‘œë§ˆë‹¤ ë‹¤ë¥¸ ë‹¹ì„  ê¸°ì¤€ ì„¤ì • ê°€ëŠ¥
  - ìµœë‹¤ ë“í‘œ (`plurality`)
  - ì ˆëŒ€ ê³¼ë°˜ìˆ˜ (`absolute_majority`) 
  - íŠ¹ì • ë“í‘œìœ¨ (`percentage`) - 2/3, ê³¼ë°˜ ë“±
  - ì°¸ì„ì ê¸°ì¤€ / ë°œê¸‰ ì½”ë“œ ê¸°ì¤€ ì„ íƒ

### 2. ì°¸ì„ ì²´í¬ ì‹œìŠ¤í…œ
- **voter_codes.first_login_at**: ìµœì´ˆ ë¡œê·¸ì¸ ì‹œê° (ì°¸ì„ í™•ì¸)
- **voter_codes.last_login_at**: ë§ˆì§€ë§‰ ë¡œê·¸ì¸
- ë¡œê·¸ì¸ = ì°¸ì„, íˆ¬í‘œ = ë³„ë„ ì¶”ì 
- ê°™ì€ ì½”ë“œë¡œ ì—¬ëŸ¬ íˆ¬í‘œ ì°¸ì—¬ ê°€ëŠ¥

### 3. íˆ¬í‘œ ì‹œë¦¬ì¦ˆ
- **elections.series_id**: ê°™ì€ ì„ ê±°ì˜ ì—¬ëŸ¬ ì°¨ìˆ˜ ì—°ê²°
- **elections.series_title**: "2024 íšŒì¥ ì„ ê±°" ê°™ì€ ì‹œë¦¬ì¦ˆ ì œëª©
- ì¬íˆ¬í‘œ ì‹œ ì½”ë“œ ì¬ì‚¬ìš© ê°€ëŠ¥

### 4. ì¤‘ë³µ íˆ¬í‘œ ë°©ì§€
- **votes í…Œì´ë¸” UNIQUE ì œì•½**: (election_id, voter_code_id)
- í•œ ì½”ë“œëŠ” ê°™ì€ íˆ¬í‘œì— í•œ ë²ˆë§Œ ì°¸ì—¬ ê°€ëŠ¥

## ğŸš€ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

### 1. Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ì‹¤í–‰

1. [Supabase Dashboard](https://app.supabase.com) ì ‘ì†
2. í”„ë¡œì íŠ¸ ì„ íƒ
3. ì¢Œì¸¡ ë©”ë‰´ì—ì„œ **SQL Editor** í´ë¦­
4. **New query** ë²„íŠ¼ í´ë¦­
5. `supabase-migration-v2.sql` íŒŒì¼ ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê¸°
6. **Run** ë²„íŠ¼ í´ë¦­ (Ctrl+Enter)

### 2. ë¡œì»¬ì—ì„œ Supabase CLI ì‚¬ìš©

```bash
# Supabase CLI ì„¤ì¹˜ (Windows)
scoop install supabase

# ë¡œê·¸ì¸
supabase login

# ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
supabase db push --db-url "your-database-url"
```

### 3. psql ì‚¬ìš© (ê³ ê¸‰)

```bash
psql "your-database-url" < supabase-migration-v2.sql
```

## âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í™•ì¸

ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì„±ê³µí•˜ë©´ ë‹¤ìŒ ë©”ì‹œì§€ê°€ ì¶œë ¥ë©ë‹ˆë‹¤:

```
NOTICE:  âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!
NOTICE:     - elections.winning_criteria ì¶”ê°€
NOTICE:     - elections.series_id, series_title ì¶”ê°€
NOTICE:     - voter_codes.first_login_at, last_login_at ì¶”ê°€
NOTICE:     - votes í…Œì´ë¸”ì— UNIQUE ì œì•½ì¡°ê±´ ì¶”ê°€
```

## ğŸ§ª í…ŒìŠ¤íŠ¸

ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

1. **ê¸°ì¡´ íˆ¬í‘œ í™•ì¸**: ëª¨ë“  ê¸°ì¡´ íˆ¬í‘œê°€ ì •ìƒì ìœ¼ë¡œ ë³´ì´ëŠ”ì§€
2. **ë‹¹ì„  ê¸°ì¤€**: ê²°ê³¼ í˜ì´ì§€ì—ì„œ "ìµœë‹¤ ë“í‘œì" ê¸°ì¤€ì´ í‘œì‹œë˜ëŠ”ì§€
3. **í†µê³„**: ì°¸ì„ í™•ì¸, íˆ¬í‘œ ì™„ë£Œ í†µê³„ê°€ ì •ìƒì ìœ¼ë¡œ ë‚˜ì˜¤ëŠ”ì§€

## ğŸ“Š ìƒˆë¡œìš´ ê¸°ëŠ¥ ì‚¬ìš©

### 1. íˆ¬í‘œ ìƒì„± ì‹œ ë‹¹ì„  ê¸°ì¤€ ì„¤ì • (ì¶”í›„ êµ¬í˜„ ì˜ˆì •)

```json
{
  "type": "percentage",
  "percentage": 66.67,
  "base": "attended"
}
```

### 2. ê²°ê³¼ í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥í•œ ì •ë³´

- âœ… ë°œê¸‰ ì½”ë“œ / ì°¸ì„ í™•ì¸ / íˆ¬í‘œ ì™„ë£Œ êµ¬ë¶„
- âœ… ë‹¹ì„  ê¸°ì¤€ í‘œì‹œ (ì°¸ì„ì 30ëª…ì˜ 66.7% ë“±)
- âœ… ê¸°ì¤€ ë¯¸ë‹¬ ì‹œ ëª…í™•í•œ ë©”ì‹œì§€
- âœ… ë™ì  ì‹œ ê²½ê³  í‘œì‹œ

### 3. ë‹¤ìŒ ì°¨ìˆ˜ íˆ¬í‘œ ìƒì„± (ì¶”í›„ êµ¬í˜„ ì˜ˆì •)

1ì°¨ íˆ¬í‘œ ê²°ê³¼ â†’ ê¸°ì¤€ ë¯¸ë‹¬ â†’ "2ì°¨ íˆ¬í‘œ ìƒì„±" ë²„íŠ¼ â†’ ê°™ì€ ì½”ë“œ ì¬ì‚¬ìš©

## âš ï¸ ì£¼ì˜ì‚¬í•­

### ê¸°ì¡´ ë°ì´í„° ì˜í–¥

- âœ… **ê¸°ì¡´ íˆ¬í‘œ ë°ì´í„° ë³´ì¡´**: ëª¨ë“  ê¸°ì¡´ ë°ì´í„°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤
- âœ… **winning_criteria ê¸°ë³¸ê°’**: ê¸°ì¡´ íˆ¬í‘œëŠ” ìë™ìœ¼ë¡œ "ìµœë‹¤ ë“í‘œ" ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤
- âœ… **is_used ë§ˆì´ê·¸ë ˆì´ì…˜**: `is_used=true`ì¸ ì½”ë“œëŠ” ìë™ìœ¼ë¡œ `first_login_at`ì´ ì„¤ì •ë©ë‹ˆë‹¤

### ì¤‘ë³µ íˆ¬í‘œ ì œê±°

- ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ìë™ìœ¼ë¡œ ì¤‘ë³µ íˆ¬í‘œë¥¼ ì œê±°í•©ë‹ˆë‹¤
- ì¤‘ë³µì´ ìˆì„ ê²½ìš° **ê°€ì¥ ìµœê·¼ íˆ¬í‘œë§Œ ìœ ì§€**í•©ë‹ˆë‹¤
- ì¤‘ë³µì´ ì—†ë‹¤ë©´ ì•„ë¬´ ì˜í–¥ ì—†ìŠµë‹ˆë‹¤

## ğŸ”„ ë¡¤ë°± (ë¬¸ì œ ë°œìƒ ì‹œ)

ë¬¸ì œê°€ ë°œìƒí•˜ë©´ ë‹¤ìŒ SQLë¡œ ë˜ëŒë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```sql
-- ì¶”ê°€ëœ ì»¬ëŸ¼ ì œê±°
ALTER TABLE elections 
  DROP COLUMN IF EXISTS winning_criteria,
  DROP COLUMN IF EXISTS series_id,
  DROP COLUMN IF EXISTS series_title;

ALTER TABLE voter_codes 
  DROP COLUMN IF EXISTS first_login_at,
  DROP COLUMN IF EXISTS last_login_at;

-- UNIQUE ì œì•½ì¡°ê±´ ì œê±°
ALTER TABLE votes 
  DROP CONSTRAINT IF EXISTS votes_election_voter_unique;

-- ì¸ë±ìŠ¤ ì œê±°
DROP INDEX IF EXISTS idx_elections_series;
DROP INDEX IF EXISTS idx_voter_codes_first_login;
DROP INDEX IF EXISTS idx_votes_voter_code;
```

## ğŸ“ ë¬¸ì œ í•´ê²°

### "relation does not exist" ì˜¤ë¥˜

â†’ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”

### "permission denied" ì˜¤ë¥˜

â†’ ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤

### ì¤‘ë³µ íˆ¬í‘œ ê´€ë ¨ ì˜¤ë¥˜

â†’ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤. ê·¸ë˜ë„ ë¬¸ì œê°€ ìˆë‹¤ë©´ ë¨¼ì € votes í…Œì´ë¸”ì˜ ì¤‘ë³µ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”:

```sql
SELECT election_id, voter_code_id, COUNT(*) 
FROM votes 
GROUP BY election_id, voter_code_id 
HAVING COUNT(*) > 1;
```

## ğŸ‰ ì™„ë£Œ!

ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì™„ë£Œë˜ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¬ì‹œì‘í•˜ê³  ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!
